name: CI/CD Pipeline - ServiCiudad

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  JAVA_VERSION: 17

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  build-test:
    name: Build & Test (CI)
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: serviciudad_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
          MYSQL_ROOT_PASSWORD: root_test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Wait for MySQL
        run: |
          timeout 30 bash -c 'until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_test_password 2>/dev/null; do sleep 2; done'

      - name: Build and run tests with coverage
        run: |
          mvn -B clean verify
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/serviciudad_test?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: test_user
          SPRING_DATASOURCE_PASSWORD: test_password
          SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop

      - name: Display coverage report
        run: |
          echo "üìä Reporte de cobertura generado en target/site/jacoco/index.html"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 30

  canary-deploy:
    name: Deploy Canary to AWS
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Deploy Canary via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "üöÄ Iniciando despliegue Canary en AWS..."
            
            # 1. Actualizar c√≥digo
            cd PROYECTO_SERVICIUDAD
            git fetch --all
            git reset --hard origin/main
            
            # 2. Construir nueva imagen
            echo "üî® Construyendo imagen Docker..."
            docker build -t serviciudad:latest .
            
            # 3. Reiniciar Canary (Puerto 8081)
            echo "üîÑ Reiniciando contenedor Canary..."
            docker stop serviciudad-canary || true
            docker rm serviciudad-canary || true
            
            docker run -d \
              --name serviciudad-canary \
              -p 8081:8080 \
              -e SPRING_PROFILES_ACTIVE=production \
              -e SPRING_DATASOURCE_URL='jdbc:mysql://database-1.cvmwk06wg5sd.us-east-2.rds.amazonaws.com:3306/serviciudad_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true' \
              -e SPRING_DATASOURCE_USERNAME='admin' \
              -e SPRING_DATASOURCE_PASSWORD='soyeladmin123' \
              serviciudad:latest
              
            echo "‚úÖ Canary desplegado en puerto 8081"

  canary-test:
    name: Verify Canary Health
    runs-on: ubuntu-latest
    needs: canary-deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Check Health via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "üè• Verificando salud de los servicios..."
            sleep 15 # Esperar a que Spring Boot arranque
            
            # Verificar Stable (Debe seguir vivo)
            echo "üîç Verificando Stable (8080)..."
            if curl -s -f "http://localhost:8080/api/v1/clientes/0001234567/deuda-consolidada" > /dev/null; then
              echo "‚úÖ Stable OK"
            else
              echo "‚ö†Ô∏è Stable no responde (puede ser normal si es el primer despliegue)"
            fi
            
            # Verificar Canary (Debe estar vivo y con nueva versi√≥n)
            echo "üîç Verificando Canary (8081)..."
            if curl -s -f "http://localhost:8081/api/v1/clientes/0001234567/deuda-consolidada" > /dev/null; then
              echo "‚úÖ Canary OK"
            else
              echo "‚ùå Canary fall√≥"
              exit 1
            fi

  promote:
    name: Promote to Stable
    runs-on: ubuntu-latest
    environment: canary-approval
    needs: canary-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Promote via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "üéâ Promocionando Canary a Stable..."
            
            # 1. Etiquetar imagen probada como stable
            docker tag serviciudad:latest serviciudad:stable
            
            # 2. Reiniciar Stable (Puerto 8080) con la nueva imagen
            echo "üîÑ Actualizando contenedor Stable..."
            docker stop serviciudad-stable || true
            docker rm serviciudad-stable || true
            
            docker run -d \
              --name serviciudad-stable \
              -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=production \
              -e SPRING_DATASOURCE_URL='jdbc:mysql://database-1.cvmwk06wg5sd.us-east-2.rds.amazonaws.com:3306/serviciudad_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true' \
              -e SPRING_DATASOURCE_USERNAME='admin' \
              -e SPRING_DATASOURCE_PASSWORD='soyeladmin123' \
              serviciudad:stable
              
            echo "‚úÖ Despliegue completado. Ambas versiones est√°n sincronizadas."
